<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>3D Foot Mapping</title>
  <style>
    body { margin: 0; overflow: hidden; background: #dfe6ee; }
    canvas { display: block; }
    #ui {
      position: absolute; top: 10px; left: 10px;
      display: flex; gap: 10px;
    }
    button {
      background: #4CAF50; color: white;
      border: none; border-radius: 6px;
      padding: 6px 12px; font: 14px system-ui, sans-serif;
      cursor: pointer;
    }
    button:hover { background: #45a049; }
  </style>
</head>
<body>
<div id="ui">
  <button id="leftBtn">Left Foot</button>
  <button id="rightBtn">Right Foot</button>
  <button id="undoBtn">Undo</button>
  <button id="clearBtn">Clear</button>
  <button id="downloadBtn">Download CSV</button>
</div>

<script type="module">
  import * as THREE from "https://unpkg.com/three@0.165.0/build/three.module.js?module";
  import { OrbitControls } from "https://unpkg.com/three@0.165.0/examples/jsm/controls/OrbitControls.js?module";
  import { GLTFLoader } from "https://unpkg.com/three@0.165.0/examples/jsm/loaders/GLTFLoader.js?module";

  const urls = {
    left: "https://stuart-mcneill.github.io/3DFoot/Leftfoot.gltf",
    right: "https://stuart-mcneill.github.io/3DFoot/Rightfoot.gltf"
  };

  const regionMap = {
    COLOR_0:"Medial Arch", COLOR_1:"Plantar Toe 1", COLOR_2:"Dorsal MTP 1", COLOR_3:"Plantar MTP 1",
    COLOR_4:"Dorsal Toe 2", COLOR_5:"Plantar Toe 2", COLOR_6:"Dorsal MTP 2", COLOR_7:"Plantar MTP 2",
    COLOR_8:"Dorsal Toe 3", COLOR_9:"Plantar Toe 3", COLOR_10:"Dorsal MTP 3", COLOR_11:"Plantar MTP 3",
    COLOR_12:"Dorsal Toe 4", COLOR_13:"Plantar Toe 4", COLOR_14:"Dorsal MTP 4", COLOR_15:"Plantar MTJ 4",
    COLOR_16:"Dorsal Toe 5", COLOR_17:"Plantar Toe 5", COLOR_18:"Dorsal MTP 5", COLOR_19:"Plantar MTP 5",
    COLOR_20:"Dorsal Midfoot", COLOR_21:"Dorsal Ankle", COLOR_22:"Plantar Lateral", COLOR_23:"Plantar Heel",
    COLOR_24:"Posterior Heel", COLOR_25:"Posterior Insertion", COLOR_26:"Posterior Midportion", COLOR_27:"Posterior Leg",
    COLOR_28:"Medial MTP", COLOR_29:"Medial Midfoot", COLOR_30:"Lateral Midfoot", COLOR_31:"Posterior Medial",
    COLOR_32:"Posterior Lateral", COLOR_33:"Medial Leg", COLOR_34:"Lateral Leg", COLOR_35:"Dorsal Toe 1"
  };

  const scene = new THREE.Scene();
  const camera = new THREE.PerspectiveCamera(45, window.innerWidth/window.innerHeight, 0.01, 1000);
  camera.position.set(0,1,2);

  const renderer = new THREE.WebGLRenderer({ antialias:true });
  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.outputColorSpace = THREE.SRGBColorSpace;
  document.body.appendChild(renderer.domElement);

  const controls = new OrbitControls(camera, renderer.domElement);
  controls.enableDamping = true;

  scene.add(new THREE.HemisphereLight(0xffffff, 0x444444, 1));
  const dirLight = new THREE.DirectionalLight(0xffffff, 0.9);
  dirLight.position.set(3,10,10);
  scene.add(dirLight);

  let currentFoot = "left";
  let footMesh = null;
  let colorAttrs = [];
  let history = [];
  let annotations = [];
  const loader = new GLTFLoader();
  const raycaster = new THREE.Raycaster();
  const mouse = new THREE.Vector2();

  function loadFoot(side){
    if(footMesh){
      scene.remove(footMesh.parent || footMesh);
      footMesh=null;
      colorAttrs=[];
      history=[];
      annotations=[];
    }

    loader.load(urls[side], async (gltf)=>{
      const root = gltf.scene;
      scene.add(root);
      root.traverse((obj)=>{
        if(obj.isMesh){
          obj.material = new THREE.MeshStandardMaterial({ vertexColors:true, metalness:0, roughness:1 });
          footMesh = obj;
          const geometry = obj.geometry;
          // hide all vertex color layers by default
          const accessorDefs = gltf.parser.json.meshes[0].primitives[0].attributes;
          for(const key in accessorDefs){
            if(key.startsWith("COLOR_")){
              const accessorIndex = accessorDefs[key];
              gltf.parser.getDependency("accessor",accessorIndex).then(accessor=>{
                geometry.setAttribute(key,new THREE.BufferAttribute(accessor.array, accessor.itemSize, accessor.normalized));
                colorAttrs.push(key);
              });
            }
          }
        }
      });
      // Initially set visible color to white
      if(footMesh){
        const g = footMesh.geometry;
        const attrName = colorAttrs[0];
        g.setAttribute("color", new THREE.BufferAttribute(new Float32Array(g.attributes.position.count*3),3));
      }
    });
  }

  function paintRegion(intersect){
    if(!footMesh) return;
    const geometry = intersect.object.geometry;
    const face = intersect.face;
    if(!face) return;

    // Determine dominant vertex color layer
    let selectedLayer = null;
    for(const attr of colorAttrs){
      if(geometry.attributes[attr]){
        selectedLayer = attr;
        break;
      }
    }
    if(!selectedLayer) return;

    const regionName = regionMap[selectedLayer] || "Unknown";

    // Paint face vertices red
    [face.a, face.b, face.c].forEach(i=>{
      geometry.attributes.color.setXYZ(i,1,0,0);
    });
    geometry.attributes.color.needsUpdate=true;

    // Save history
    history.push({geometry, vertices:[face.a,face.b,face.c], prevColor:[[0,0,0],[0,0,0],[0,0,0]], region:regionName});
    annotations.push({foot:currentFoot, region:regionName, time:new Date().toISOString()});
  }

  function undo(){
    const last = history.pop();
    if(!last) return;
    last.vertices.forEach((i,idx)=>{
      last.geometry.attributes.color.setXYZ(i, ...last.prevColor[idx]);
    });
    last.geometry.attributes.color.needsUpdate=true;
    annotations.pop();
  }

  function clearAll(){
    if(!footMesh) return;
    const g = footMesh.geometry;
    for(let i=0;i<g.attributes.color.count;i++){
      g.attributes.color.setXYZ(i,0,0,0);
    }
    g.attributes.color.needsUpdate=true;
    history=[];
    annotations=[];
  }

  function downloadCSV(){
    const csv="Foot,Region,Timestamp\n"+annotations.map(a=>`${a.foot},${a.region},${a.time}`).join("\n");
    const blob=new Blob([csv],{type:"text/csv"});
    const link=document.createElement("a");
    link.href=URL.createObjectURL(blob);
    link.download="foot_annotations.csv";
    link.click();
  }

  window.addEventListener("click",(e)=>{
    if(!footMesh) return;
    mouse.x=(e.clientX/window.innerWidth)*2-1;
    mouse.y=-(e.clientY/window.innerHeight)*2+1;
    raycaster.setFromCamera(mouse,camera);
    const intersects=raycaster.intersectObject(footMesh,true);
    if(intersects.length>0){
      paintRegion(intersects[0]);
    }
  });

  document.getElementById("undoBtn").onclick=undo;
  document.getElementById("clearBtn").onclick=clearAll;
  document.getElementById("downloadBtn").onclick=downloadCSV;
  document.getElementById("leftBtn").onclick=()=>{currentFoot="left"; loadFoot("left");};
  document.getElementById("rightBtn").onclick=()=>{currentFoot="right"; loadFoot("right");};

  loadFoot("left");

  function animate(){
    requestAnimationFrame(animate);
    controls.update();
    renderer.render(scene,camera);
  }
  animate();

  window.addEventListener("resize",()=>{
    camera.aspect=window.innerWidth/window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth,window.innerHeight);
  });
</script>
</body>
</html>
