<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>3D Foot Pain Mapper</title>
    <style>
      body {
        margin: 0;
        overflow: hidden;
      }
      #footSelector {
        position: absolute;
        top: 10px;
        left: 10px;
        z-index: 1;
        padding: 6px;
        font-size: 16px;
      }
    </style>
  </head>
  <body>
    <select id="footSelector">
      <option value="LeftFoot.glb">Left Foot</option>
      <option value="RightFoot.glb">Right Foot</option>
    </select>

    <script type="module">
      import * as THREE from 'https://unpkg.com/three@0.150.1/build/three.module.js'
      import { GLTFLoader } from 'https://unpkg.com/three@0.150.1/examples/jsm/loaders/GLTFLoader.js'
      import { OrbitControls } from 'https://unpkg.com/three@0.150.1/examples/jsm/controls/OrbitControls.js'

      const scene = new THREE.Scene()
      scene.background = new THREE.Color(0xf0f0f0)

      const camera = new THREE.PerspectiveCamera(
        45,
        window.innerWidth / window.innerHeight,
        0.1,
        1000
      )
      camera.position.set(0, 1, 5)

      const renderer = new THREE.WebGLRenderer({ antialias: true })
      renderer.setSize(window.innerWidth, window.innerHeight)
      document.body.appendChild(renderer.domElement)

      const controls = new OrbitControls(camera, renderer.domElement)
      controls.enableDamping = true

      const light = new THREE.HemisphereLight(0xffffff, 0x444444, 1)
      scene.add(light)

      const loader = new GLTFLoader()
      let currentModel = null

      function loadModel(fileName) {
        const url = `https://stuart-mcneill.github.io/3DFoot/${fileName}`
        console.log('Loading model:', url)

        loader.load(
          url,
          (gltf) => {
            console.log('Model loaded:', fileName)
            if (currentModel) scene.remove(currentModel)
            currentModel = gltf.scene
            currentModel.scale.set(10, 10, 10)
            currentModel.position.set(0, 0, 0)
            scene.add(currentModel)
          },
          undefined,
          (error) => {
            console.error('Error loading model:', error)
          }
        )
      }

      // Initial load
      loadModel('LeftFoot.glb')

      // Dropdown change
      document.getElementById('footSelector').addEventListener('change', (e) => {
        loadModel(e.target.value)
      })

      // Raycasting for pain points
      const raycaster = new THREE.Raycaster()
      const mouse = new THREE.Vector2()

      function addMarker(position) {
        const marker = new THREE.Mesh(
          new THREE.SphereGeometry(0.05, 16, 16),
          new THREE.MeshStandardMaterial({ color: 0xff0000 })
        )
        marker.position.copy(position)
        scene.add(marker)
      }

      renderer.domElement.addEventListener('click', (event) => {
        const rect = renderer.domElement.getBoundingClientRect()
        mouse.x = ((event.clientX - rect.left) / rect.width) * 2 - 1
        mouse.y = -((event.clientY - rect.top) / rect.height) * 2 + 1

        raycaster.setFromCamera(mouse, camera)
        if (currentModel) {
          const intersects = raycaster.intersectObject(currentModel, true)
          if (intersects.length > 0) {
            const point = intersects[0].point
            addMarker(point)
            console.log('Pain point:', point)
          }
        }
      })

      window.addEventListener('resize', () => {
        camera.aspect = window.innerWidth / window.innerHeight
        camera.updateProjectionMatrix()
        renderer.setSize(window.innerWidth, window.innerHeight)
      })

      function animate() {
        requestAnimationFrame(animate)
        controls.update()
        renderer.render(scene, camera)
      }

      animate()
    </script>
  </body>
</html>
