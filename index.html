<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>3D Foot Region Detection</title>
  <style>
    body { margin: 0; overflow: hidden; }
    #exportBtn {
      position: absolute;
      top: 10px;
      left: 10px;
      padding: 8px 12px;
      background: #0078D4;
      color: white;
      border: none;
      cursor: pointer;
      font-weight: bold;
      z-index: 1;
    }
  </style>
</head>
<body>
  <button id="exportBtn">Export CSV</button>
  <script type="module">
    import * as THREE from 'https://unpkg.com/three@0.165.0/build/three.module.js';
    import { GLTFLoader } from 'https://unpkg.com/three@0.165.0/examples/jsm/loaders/GLTFLoader.js';

    let scene, camera, renderer, raycaster, mouse;
    let targetMesh;
    const markers = [];

    const colorAttrs = Array.from({ length: 36 }, (_, i) => `COLOR_${i}`);

    const regionMaps = {
      left: {
        COLOR_0: "Medial Arch", COLOR_1: "Plantar Toe 1", COLOR_2: "Dorsal MTP 1", COLOR_3: "Plantar MTP 1",
        COLOR_4: "Dorsal Toe 2", COLOR_5: "Plantar Toe 2", COLOR_6: "Dorsal MTP 2", COLOR_7: "Plantar MTP 2",
        COLOR_8: "Dorsal Toe 3", COLOR_9: "Plantar Toe 3", COLOR_10: "Dorsal MTP 3", COLOR_11: "Plantar MTP 3",
        COLOR_12: "Dorsal Toe 4", COLOR_13: "Plantar Toe 4", COLOR_14: "Dorsal MTP 4", COLOR_15: "Plantar MTJ 4",
        COLOR_16: "Dorsal Toe 5", COLOR_17: "Plantar Toe 5", COLOR_18: "Dorsal MTP 5", COLOR_19: "Plantar MTP 5",
        COLOR_20: "Dorsal Midfoot", COLOR_21: "Dorsal Ankle", COLOR_22: "Plantar Lateral", COLOR_23: "Plantar Heel",
        COLOR_24: "Posterior Heel", COLOR_25: "Posterior Insertion", COLOR_26: "Posterior Midportion",
        COLOR_27: "Posterior Leg", COLOR_28: "Medial MTP", COLOR_29: "Medial Midfoot", COLOR_30: "Lateral Midfoot",
        COLOR_31: "Posterior Medial", COLOR_32: "Posterior Lateral", COLOR_33: "Medial Leg", COLOR_34: "Lateral Leg",
        COLOR_35: "Dorsal Toe 1"
      },
      right: {
        COLOR_0: "Dorsal Toe 1", COLOR_1: "Plantar Toe 1", COLOR_2: "Dorsal MTP 1", COLOR_3: "Plantar MTP 1",
        COLOR_4: "Dorsal Toe 2", COLOR_5: "Plantar Toe 2", COLOR_6: "Dorsal MTP 2", COLOR_7: "Plantar MTP 2",
        COLOR_8: "Dorsal Toe 3", COLOR_9: "Plantar Toe 3", COLOR_10: "Dorsal MTP 3", COLOR_11: "Plantar MTP 3",
        COLOR_12: "Dorsal Toe 4", COLOR_13: "Plantar Toe 4", COLOR_14: "Dorsal MTP 4", COLOR_15: "Plantar MTJ 4",
        COLOR_16: "Dorsal Toe 5", COLOR_17: "Plantar Toe 5", COLOR_18: "Dorsal MTP 5", COLOR_19: "Plantar MTP 5",
        COLOR_20: "Dorsal Midfoot", COLOR_21: "Dorsal Ankle", COLOR_22: "Medial Arch", COLOR_23: "Plantar Lateral",
        COLOR_24: "Plantar Heel", COLOR_25: "Posterior Heel", COLOR_26: "Posterior Insertion",
        COLOR_27: "Posterior Midportion", COLOR_28: "Posterior Leg", COLOR_29: "Medial MTP", COLOR_30: "Medial Midfoot",
        COLOR_31: "Lateral Midfoot", COLOR_32: "Posterior Medial", COLOR_33: "Posterior Lateral",
        COLOR_34: "Medial Leg", COLOR_35: "Lateral Leg"
      }
    };

    const clinicalPriority = colorAttrs; // Use full list for now

    const currentFoot = "left"; // Change to "right" if needed

    init();
    animate();

    function init() {
      scene = new THREE.Scene();
      camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
      camera.position.set(0, 0, 2);

      renderer = new THREE.WebGLRenderer({ antialias: true });
      renderer.setSize(window.innerWidth, window.innerHeight);
      document.body.appendChild(renderer.domElement);

      raycaster = new THREE.Raycaster();
      mouse = new THREE.Vector2();

      const light = new THREE.HemisphereLight(0xffffff, 0x444444);
      scene.add(light);

      const loader = new GLTFLoader();
      const url = currentFoot === "left"
        ? "https://stuart-mcneill.github.io/3DFoot/Leftfoot.gltf"
        : "https://stuart-mcneill.github.io/3DFoot/Rightfoot.gltf";

      loader.load(url, gltf => {
        targetMesh = gltf.scene.children[0];
        scene.add(targetMesh);
      });

      window.addEventListener('click', onClick);
      document.getElementById('exportBtn').addEventListener('click', exportCSV);
    }

    function onClick(event) {
      mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
      mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;

      raycaster.setFromCamera(mouse, camera);
      const intersects = raycaster.intersectObject(targetMesh);

      if (intersects.length > 0) {
        const intersect = intersects[0];
        const matchedRegions = detectRegionsFromClick(intersect);

        placeMarker(intersect.point);

        markers.push({
          x: intersect.point.x.toFixed(3),
          y: intersect.point.y.toFixed(3),
          z: intersect.point.z.toFixed(3),
          regions: matchedRegions.map(r => r.regionName).join("; "),
          layers: matchedRegions.map(r => r.attrName).join("; ")
        });

        console.log("ðŸ§  Regions:", matchedRegions);
      }
    }

    function detectRegionsFromClick(intersect) {
      const face = intersect.face;
      const geometry = targetMesh.geometry;
      const i1 = face.a, i2 = face.b, i3 = face.c;

      const matches = [];

      for (const attrName of colorAttrs) {
        const colorAttr = geometry.attributes[attrName];
        if (!colorAttr) continue;

        const c1 = new THREE.Color().fromArray(colorAttr.array, i1 * 3);
        const c2 = new THREE.Color().fromArray(colorAttr.array, i2 * 3);
        const c3 = new THREE.Color().fromArray(colorAttr.array, i3 * 3);
        const avg = new THREE.Color(
          (c1.r + c2.r + c3.r) / 3,
          (c1.g + c2.g + c3.g) / 3,
          (c1.b + c2.b + c3.b) / 3
        );

        const intensity = avg.r + avg.g + avg.b;
        if (intensity > 0.01) {
          const regionName = regionMaps[currentFoot]?.[attrName] || "Unknown Region";
          matches.push({ attrName, regionName, intensity });
        }
      }

      matches.sort((a, b) => {
        const pA = clinicalPriority.indexOf(a.attrName);
        const pB = clinicalPriority.indexOf(b.attrName);
        return (pA === -1 ? 999 : pA) - (pB === -1 ? 999 : pB);
      });

      return matches;
    }

    function placeMarker(position) {
      const geometry = new THREE.SphereGeometry(0.005, 8, 8);
      const material = new THREE.MeshBasicMaterial({ color: 0xff0000 });
      const marker = new THREE.Mesh(geometry, material);
      marker.position.copy(position);
      scene.add(marker);
    }


    function exportCSV() {
      let csv = "x,y,z,regions,layers\n";
      markers.forEach(m => {
        csv += `${m.x},${m.y},${m.z},"${m.regions}","${m.layers}"\n`;
      });

      const blob = new Blob([csv], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "foot_markers.csv";
      a.click();
      URL.revokeObjectURL(url);
    }

    function animate() {
      requestAnimationFrame(animate);
      renderer.render(scene, camera);
    }
  </script>
</body>
</html>
